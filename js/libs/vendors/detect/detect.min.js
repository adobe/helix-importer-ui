// Adobe Corp. internal project "webpage-blueprint-detector" - Author: catalan@adobe.com
(()=>{{let s=i=>{typeof i[0]=="string"&&!i[0].startsWith("[detect]")&&(i[0]=`[detect] ${i[0]}`)},e=console.log;console.log=(...i)=>{s(i),e(...i)},console.debug=(...i)=>{window.DEBUG&&(s(i),e(...i))};let n=console.warn;console.warn=(...i)=>{s(i),n(...i)};let t=console.error;console.error=(...i)=>{s(i),t(...i)}}function T(s){return s.toString(16)}function H(s,e,n,t){return T(s)+T(e)+T(n)+T(t)}var v=class s{constructor({r:e,g:n,b:t,a:i=1,name:l=""}){this.name=l,this.r=e,this.g=n,this.b=t,this.a=i}toHex(){return H(this.r,this.g,this.b,this.a)}static fromRGBA(e){let n=e.replace("rgba(","").replace(")","").split(",").map(t=>parseInt(t.trim()));return new s({r:n[0],g:n[1],b:n[2],a:n[3]})}toRGBA(){return`rgba(${this.r}, ${this.g}, ${this.b}, ${this.a})`}withAlpha(e){return new s({...this,a:e})}static random(e=!1){let n=Math.round(Math.random()*255),t=Math.round(Math.random()*255),i=Math.round(Math.random()*255),l=e?Math.random():1;return new s({name:`rand-${n}-${t}-${i}-${l}`,r:n,g:t,b:i,a:l})}static fromHex(e){let n=parseInt(e.substring(0,2),16),t=parseInt(e.substring(2,4),16),i=parseInt(e.substring(4,6),16),l=parseInt(e.substring(6,8),16);return new s({name:`hex-${n}-${t}-${i}-${l}`,r:n,g:t,b:i,a:l})}};function L(s,e){let n=Math.max(0,Math.min(s.x+s.width,e.x+e.width)-Math.max(s.x,e.x)),t=Math.max(0,Math.min(s.y+s.height,e.y+e.height)-Math.max(s.y,e.y)),i=n*t,l=e.width*e.height;return i/l*100}function R(s,e){let n=s.getBoundingClientRect();return{left:n.left+e.document.scrollingElement.scrollLeft,top:n.top+e.document.scrollingElement.scrollTop}}var S=class s{constructor(e,n,t,i,l){this.id=crypto.randomUUID(),this.x=Math.floor(e),this.y=Math.floor(n),this.width=Math.floor(t),this.height=Math.floor(i),this.div=l,this.children=[],this.prediction=null,this.layout=null}static fromDiv(e,n){let t=e.getBoundingClientRect(),i=R(e,n);return new s(i.left,i.top,t.width,t.height,e)}static areBoxesLaidOutAsGrid(e){console.log("areBoxesLaidOutAsGrid");try{if(e.length<2)return!1;let n=e.slice().sort((o,r)=>o.x-r.x||o.y-r.y),t=e.slice().sort((o,r)=>o.y-r.y||o.x-r.x);console.log(n),console.log(t);let i=[];for(let o=1;o<n.length;o++)i.push(n[o].x-n[o-1].x);if([...new Set(i)].length>1)return!1;let a=[];for(let o=1;o<t.length;o++)a.push(t[o].y-t[o-1].y);return!([...new Set(a)].length>1)}finally{return!0}}contains(e,n=!0){return n?e.x-e.width>=this.x-this.width&&e.x+e.width<=this.x+this.width&&e.y-e.height>=this.y-this.height&&e.y+e.height<=this.y+this.height:L(this,e)>75}intersects(e){return!(e.x-e.width>this.x+this.width||e.x+e.width<this.x-this.width||e.y-e.height>this.y+this.height||e.y+e.height<this.y-this.height)}isInside(e){return e.x-e.width<=this.x-this.width&&e.x+e.width>=this.x+this.width&&e.y-e.height<=this.y-this.height&&e.y+e.height>=this.y+this.height}addChild(e){this.children.push(e)}isChild(e){return this.children.some(this.isChild)}determineLayout(){return this.layout={numCols:D(this.children),numRows:O(this.children)},this.layout}toJSONString(){function e(t){return{id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,layout:t.layout,prediction:t.prediction,template:t.template,xpath:t.xpath,xpathWithDetails:t.xpathWithDetails,children:t.children.map(e)}}let n=e(this);return console.log(n),n}};function D(s){if(!s.length)return 0;let e=[];return s.slice().sort((n,t)=>n.x-t.x).forEach(n=>{let t=n.x,i=n.x+n.width,l=e[e.length-1];l?t>=l-5&&e.push(i):e.push(i)}),e.length}function O(s){if(!s.length)return 0;let e=[];return s.slice().sort((n,t)=>n.y-t.y).forEach(n=>{let t=n.y,i=n.y+n.height,l=e[e.length-1];l?t>=l-5&&e.push(i):e.push(i)}),e.length}var p=class s{static getXPath(e,n,t=!1){for(var i=n.getElementsByTagName("*"),l=[];e&&e.nodeType==1;e=e.parentNode)if(t)if(e.hasAttribute("id")){for(var a=0,c=0;c<i.length&&(i[c].hasAttribute("id")&&i[c].id==e.id&&a++,!(a>1));c++);if(a==1)return l.unshift('id("'+e.getAttribute("id")+'")'),l.join("/");l.unshift(e.localName.toLowerCase()+'[@id="'+e.getAttribute("id")+'"]')}else e.hasAttribute("class")&&l.unshift(e.localName.toLowerCase()+'[@class="'+[...e.classList].join(" ").trim()+'"]');else{for(var o=1,r=e.previousSibling;r;r=r.previousSibling)r.localName==e.localName&&(o+=1);l.unshift(e.localName.toLowerCase()+"["+o+"]")}return l.length?"/"+l.join("/"):null}static isVisible(e,n){if(!e)return!1;if(e.nodeType===n.Node.DOCUMENT_NODE)return!0;if(e.nodeType===n.Node.ELEMENT_NODE){let t=n.getComputedStyle(e);return t.display.includes("none")||t.visibility.includes("hidden")||t.opacity==="0"?!1:s.isVisible(e.parentNode,n)}}static isUserVisible(e,n){if(!s.isVisible(e,n))return!1;let t=e.getBoundingClientRect(),{width:i,height:l}=s.getPageSize(n.document);return!(t.height===0||t.width===0)}static getNSiblingsDivs(e,n,t=null){let i=t;isNaN(t)||(i=c=>c===t);let l="",a=[];e.querySelectorAll("div").forEach(c=>{let o=s.getXPath(c,n),r=o.substring(0,o.lastIndexOf("["));a[r]?a[r].push(c):a[r]=[c]});for(let c in a)if(i(a[c].length)){l=c;break}return a[l]||null}static getPageSize(e){var n=e.documentElement,t=e.body,i=Math.max(n.clientWidth,n.scrollWidth,n.offsetWidth,t.scrollWidth,t.offsetWidth),l=Math.max(n.clientHeight,n.scrollHeight,n.offsetHeight,t.scrollHeight,t.offsetHeight);return{width:i,height:l}}static getOffsetRect(e,n){let t=e.getBoundingClientRect(),i=n.document?.scrollingElement?.scrollLeft||0,l=n.document?.scrollingElement?.scrollTop||0;return{x:t.left+i,y:t.top+l,width:t.width,height:t.height}}static checkElStackUpCSSClasses(e,n){let t=e;for(;t;){if(t.classList.contains(n))return!0;t=t.parentElement}return!1}static getAllVisibleElements=(e=document.body,n)=>{let t=[...e.querySelectorAll("*")].filter(a=>!["IFRAME","NOSCRIPT","BR","EM","STRONG","STYLE","SCRIPT"].includes(a.nodeName)).reduce((a,c,o)=>{var r=c.closest("svg");return!(r!==null&&r!==c)&&!a.includes(c.nodeName)&&a.push(c.nodeName),a},[]);console.debug("DOM node types:",t);let l=[...e.querySelectorAll(t.join(","))].filter(a=>s.isUserVisible(a,n));return console.log(`found ${l.length} visible elements in the page.`),l}};var w=class{constructor(...e){e.reduce((n,t,i)=>(n[t]=1<<i,n),this)}},C=class{#e=0;constructor(...e){this.#e=0,this.setFlags(...e)}get flag(){return this.#e}setFlags(...e){this.#e=e.reduce((n,t)=>n|t,0)}setFlag(e){this.#e|=e}unsetFlag(e){this.#e&=~e}isFlagSet(e){return(this.#e&e)!==0}areOnlyFlagsSet(...e){let n=e.reduce((t,i)=>t|i,0);return this.#e===n}getFlags(e){return Object.keys(e).filter(n=>this.isFlagSet(e[n]))}};function E(s){var e=0,n=s.length,t=0;if(n>0)for(;t<n;)e=(e<<5)-e+s.charCodeAt(t++)|0;return e}function I(s,...e){return(...n)=>{let t=n[n.length-1]||{},i=[s[0]];return e.forEach((l,a)=>{let c=Number.isInteger(l)?n[l]:t[l];i.push(c,s[a+1])}),i.join("")}}function B(s,e){let n=null,t=null;return n=[...s.querySelectorAll("*")].some(i=>{let l=e.getComputedStyle(i),a=i.getBoundingClientRect(),c=l.backgroundImage||"none",o="none";if(o&&o.includes("rgba")&&Color.fromRGBA(o).a===0&&(o="none"),c.includes("none")&&o.includes("none"))return!1;if(c||o)return t=i,!0}),n||(n=[...s.querySelectorAll("img")].some(i=>p.isUserVisible(i,e)),n)?t:n}var u=window.xp??{},b=class{constructor({sectionType:e,sectionFeatures:n,template:t,confidence:i}){this.sectionType=e,this.sectionFeatures=n,this.template=t,this.confidence=i}},M=[{name:"carousel",predictFn:(s,e,n,t,i)=>{console.log(s.div),console.groupCollapsed(">>> carousel");let l=p.getNSiblingsDivs(s.div,i.document,a=>a>=2);if(l){console.log("predict carousel"),console.log(l);let a={};l.forEach(o=>{let r=p.getXPath(o,i.document),d=[...o.querySelectorAll("div")].map(y=>p.getXPath(y,i.document).slice(r.length));console.log(d);let h=E(d.join(`
`));console.log(h),a[h]?a[h].push(o):a[h]=[o]}),console.groupEnd();let c=Object.keys(a).filter(o=>a[o].length>1);if(a[c]){let o=!1,r=!1;if(a[c].forEach(d=>{let h=d.getBoundingClientRect();!p.isVisible(d,i)||h.x+h.width>i.innerWidth?r=!0:o=!0}),o&&r)return!0}return!1}return console.groupEnd(),!1}},{name:"columns",predictFn:(s,e,n,t,i)=>(console.log("flags",t.getFlags(g)),t.isFlagSet(g.isGridLayout))},{name:"hero",predictFn:(s,e,n,t,i)=>s.height<=i.innerHeight&&t.isFlagSet(g.hasBackground)&&t.isFlagSet(g.hasHeading)&&t.isFlagSet(g.hasCTA)},{name:"default-content",predictFn:(s,e,n,t,i)=>{let l=!0;[...s.div.querySelectorAll("img")].some(o=>{let r=o.getBoundingClientRect();return r.width>50&&r.height>50})&&(l=!1);let c=!s.children.some(o=>(console.log(o.prediction?.sectionType),!["heading","text","text+icons"].includes(o.prediction?.sectionType)));return console.log("childrenOnlyTextLike",c),t.isFlagSet(g.hasTexts)&&!t.isFlagSet(g.hasImages)&&!t.isFlagSet(g.hasBackground)||!t.isFlagSet(g.isGridLayout)&&c&&t.isFlagSet(g.hasTexts)&&l&&!t.isFlagSet(g.hasBackground)}}];u.DOM=p;u.Flags=w;u.FlagSet=C;function P(s,e){let n=e.document.createElement("a");document.body.appendChild(n);let t=e.getComputedStyle(n);return[...s.querySelectorAll("a")].find(l=>{if(["background","background-color","background-image"].find(o=>{let r=e.getComputedStyle(l);return console.log(o,r[o],t[o]),r[o]!==t[o]}))return console.log("hasBackground"),!0;let c=0;return["left","right","top","bottom"].forEach(o=>{let r=e.getComputedStyle(l).getPropertyValue(`border-${o}-style`);console.log(o,r,t[`border-${o}-style`]),r!==t[`border-${o}-style`]&&c++}),c>1?(console.log("bordersNum"),!0):!1})!==void 0}var q=[new v({name:"violet",r:148,g:0,b:211}),new v({name:"indigo",r:75,g:0,b:130}),new v({name:"blue",r:0,g:0,b:255}),new v({name:"green",r:0,g:255,b:0}),new v({name:"yellow",r:255,g:255,b:0}),new v({name:"orange",r:255,g:127,b:0}),new v({name:"red",r:255,g:0,b:0})];u.filterDivs=s=>{let e=s.filter(t=>{let i=t.getBoundingClientRect(),{width:l,height:a}=p.getPageSize();return!t.classList.contains("xp-ui")&&!t.closest(".xp-ui")&&i.width!==0&&i.height!==0&&i.width*i.height>5e3&&i.width*i.height<.8*l*a&&p.isVisible(t,window)});console.log(e.length),console.log(e.map(t=>t));let n=e.filter(t=>{let i=t.parentElement;for(;i;){let l=t.getBoundingClientRect(),a=i.getBoundingClientRect();if(a.width===0||a.height===0){i=i.parentElement;continue}if(l.width>=.9*a.width&&l.height>=.9*a.height)return!1;i=i.parentElement}return!0});return console.log(n.length),console.log(n.map(t=>t)),n};var $=I`position:absolute;z-index:10000000;left:${0}px;top:${1}px;width:${2}px;height:${3}px;border:2px solid ${4};`,F=(s,{window:e,target:n=document.body,padding:t=0,color:i=null,label:l=null})=>{let a=i||"rgba(0, 0, 255, 1)",c=p.getOffsetRect(s.div,e),o=document.createElement("div");o.dataset.boxId=s.id,o.dataset.boxXpath=s.xpath,o.dataset.boxXpathWithDetails=s.xpathWithDetails,o.dataset.layout=JSON.stringify(s.layout);let r=(({id:d,x:h,y,width:f,height:x,xpath:m,layout:k})=>({id:d,x:h,y,width:f,height:x,xpath:m,layout:k}))(s);if((s.layout.numCols>1||s.layout.numRows>1)&&(r.childrenXpaths=s.children.map(d=>({xpath:d.xpath,xpathWithDetails:d.xpathWithDetails}))),o.dataset.boxData=JSON.stringify(r),o.className="xp-overlay",o.style=$(c.x+t,c.y+t,c.width-t*2-4,c.height-t*2-4,a),l){let d=e.document.createElement("div");d.className="xp-overlay-label",d.textContent=l,o.appendChild(d)}n.appendChild(o)};function N(s,e,n=0,t=q,i=null,l=0){s.forEach((a,c)=>{let o=i||t[c%(t.length-1)],r=l===0?1:Math.max(.1,.5-l*.1),d=o.withAlpha(r).toRGBA();a.color=d,F(a,{window:e,target:e.document.body,padding:n,color:d,label:`layout: ${a.layout.numCols}x${a.layout.numRows}`}),a.children.length>0&&N(a.children,e,n+4,t,o,l+1)})}var g=new w("isFromRootBox","hasHeader","hasTexts","hasBackground","hasHeading","hasCTA","hasImages","hasMultipleColumns","hasMultipleRows","isGridLayout","isInsideAHeaderLikeElement","isInsideAFooterLikeElement");function A(s,e,n=null,t,i=!0){if(s.ignored)return null;let l="unknown",a=new C,c=s.div;if(i&&a.setFlag(g.isFromRootBox),c){let r=c.cloneNode(!0);r.querySelectorAll("script, style, link, meta, noscript").forEach(k=>k.remove()),r.textContent.replaceAll(" ","").replaceAll(`
`,"").trim().length>0&&a.setFlag(g.hasTexts),([...c.querySelectorAll("img, picture, svg")].length>0||["IMG","PICTURE","SVG"].includes(c.nodeName))&&a.setFlag(g.hasImages),!!B(s.div,t)&&a.setFlag(g.hasBackground),([...c.querySelectorAll("h1, h2, h3, h4, h5, h6")].length>0||["H1","H2","H3","H4","H5","H6"].includes(c.nodeName))&&a.setFlag(g.hasHeading),P(c,t)&&a.setFlag(g.hasCTA);let m=s.determineLayout();m.numRows>1&&a.setFlag(g.hasMultipleRows),m.numCols>1&&a.setFlag(g.hasMultipleColumns),m.numCols>1&&S.areBoxesLaidOutAsGrid(s.children)&&a.setFlag(g.isGridLayout),(c.closest("header, .header")||p.checkElStackUpCSSClasses(c,"header"))&&a.setFlag(g.isInsideAHeaderLikeElement),(c.closest("footer, .footer")||p.checkElStackUpCSSClasses(c,"footer"))&&a.setFlag(g.isInsideAFooterLikeElement)}let o=s.children;if(o.forEach((...r)=>{A(...r,t,!1)}),!i){let r=M.find(d=>d.predictFn(s,e,null,a,t));r&&(l=r.name)}if(o.length===0&&a.isFlagSet(g.isFromRootBox)&&e===0||o.length>0&&o.every(r=>r.prediction.sectionFeatures.includes("isInsideAHeaderLikeElement"))?l="header":o.length>0&&o.every(r=>r.prediction.sectionFeatures.includes("isInsideAFooterLikeElement"))&&(l="footer"),s.prediction=new b({sectionType:l,sectionFeatures:a.getFlags(g),confidence:-1}),console.group("prediction"),console.log("prediction"),console.log(a.getFlags(g)),console.log(c),console.log("section prediction:",s.prediction),console.groupEnd(),i){let r=function(f,x){return f.children.find(m=>m.prediction.sectionType===x?!0:r(m))},d=function(f,x){let m=f.children.slice(x)[0];return!m||m.children.length===0?f.div&&f.prediction.sectionType==="unknown"?f:m:d(m,x)};if(!r(s,"header")){let f=d(s,0);f&&(f.prediction=new b({sectionType:"header",sectionFeatures:f.prediction.sectionFeatures,confidence:-1}))}if(!r(s,"footer")){let f=d(s,-1);f&&(f.prediction=new b({sectionType:"footer",sectionFeatures:f.prediction.sectionFeatures,confidence:-1}))}}return s.prediction}function G(){let s=[...document.body.querySelectorAll("*")].filter(t=>!["IFRAME","NOSCRIPT","BR","EM","STRONG","STYLE","SCRIPT"].includes(t.nodeName)).reduce((t,i,l)=>{var a=i.closest("svg");return!(a!==null&&a!==i)&&!t.includes(i.nodeName)&&t.push(i.nodeName),t},[]);console.log("DOM node types:",s);let e=[...document.querySelectorAll(s.join(","))],n=u.filterDivs(e);return console.log(`found ${n.length} visible divs to show!`),n}u.getAllVisibleDivs=G;u.buildBoxTree=(s,e)=>{let n=new S(0,0,e.innerWidth,e.document.scrollingElement.scrollHeight),t=s.map(r=>S.fromDiv(r,e));function i(r,d,h){d.forEach((y,f)=>{if(h.has(f))return;if(r.contains(y,!1)){let m=y;r.addChild(m),h.add(f),i(m,d,h)}})}i(n,t,new Set);function l(r){r.determineLayout(),r.children.forEach(l)}l(n);function a(r){if(r.children.length===1&&r.layout.numCols===1){let d=r.children[0];r.children=d.children,a(r),r.determineLayout()}else r.children.forEach(a)}a(n);function c(r){r.children.length>1&&r.layout.numCols===1&&r.children.every(d=>d.layout.numRows===0&&d.layout.numCols===0)?(r.children=[],c(r),r.determineLayout()):r.children.forEach(c)}c(n);function o(r){if(r.children.length>1){let d=r.children[0].layout.numCols;if(r.layout.numRows>1&&r.layout.numCols===1&&r.children.every(h=>h.layout.numRows===1&&h.layout.numCols>1&&h.layout.numCols===d)){console.log("mergeMultiSingleRowColums",r);let h=[];r.children.forEach(y=>{h.push(...y.children)}),r.children=h,r.determineLayout()}else r.children.forEach(o)}}return o(n),l(n),n};u.getVerticalBoxesFromHierarchy=(s,e=!0)=>{let n={...s};function t(i){let l=i.children;if(l.some(c=>l.some(o=>c!==o&&!c.isInside(o)&&(c.x>=o.x+o.width||c.x+c.width<=o.x)))){i.setChildren([]);return}else for(let c=0;c<l.length;c++)t(l[c])}return t(n),n.children};u.boxes=null;u.selectElementToIgnore=()=>{document.body.style.cursor="crosshair",u.ui.overlaysDiv().addEventListener("click",e=>{let n=e.target;n.classList.contains("xp-overlay")&&n.remove(),u.ignoreElementForDection(n.dataset.boxId),document.body.style.removeProperty("cursor")},{once:!0})};u.ignoreElementForDection=s=>{function e(n){if(n.id===s){let t=function(i){[...u.ui.overlaysDiv().querySelectorAll(".xp-overlay")].forEach(a=>{a.dataset.boxId===i.id&&a.remove()}),i.children.forEach(t)};return n.ignored=!0,t(n),!0}else return n.children.some(e)}e(u.boxes)};u.predictPage=s=>{if(u.boxes?.children?.length>0){let n=function(i){i.ignored||(i.prediction&&i.prediction.sectionType!=="unknown"||i.prediction&&i.prediction.sectionType==="unknown"&&i.children.length===0?(e.push(i),console.warn(i.div,i.prediction),u.ui&&F(i,{window:s,padding:0,color:"rgba(0, 255, 0, 1)",label:i.prediction.sectionType})):i.children.forEach(n))};u.ui?.resetOverlays(),A(u.boxes,0,null,s);let e=[];n(u.boxes);let t=u.boxes.children.map(i=>{let l=[p.getXPath(i.div,document)];return l.push(...i.children.map(a=>"- "+p.getXPath(a.div,document))),l.join(`
`)||""}).join(`
`)||"";return u.boxes.template={raw:t,hash:E(t)},u.predictedBoxes=e,console.log("final boxes",u.boxes),console.log("predicted boxes",u.predictedBoxes),u.ui?.toggleOverlays(!0),u.boxes}};u.detectSections=async(s,e,n={autoDetect:!1})=>{u.ui?.resetOverlays();let{document:t}=e,i=p.getAllVisibleElements(s,e);console.log("visible divs",i),i=i.filter(o=>{let r=o.getBoundingClientRect();return r.width*r.height>22e3}),console.log("filtered divs",i);let l=u.buildBoxTree(i,e);console.log("boxes hierarchy",l);function a(o,r){o.div&&(o.xpath=p.getXPath(o.div,r),o.xpathWithDetails=p.getXPath(o.div,r,!0),o.id=`box-id-${E(o.xpath)}`),o.children&&o.children.length>0&&o.children.forEach(d=>a(d,r))}a(l,t),u.boxes=l;let c=l.children.map(o=>{let r=[o.xpath];return r.push(...o.children.map(d=>"- "+d.xpath)),r.join(`
`)||""}).join(`
`)||"";if(console.log("template",c),u.template={raw:c,hash:E(c)},!n.autoDetect)N(l.children,e);else if(u.boxes?.children?.length>0){let r=function(h){h.ignored||(h.prediction&&h.prediction.sectionType!=="unknown"||h.prediction&&h.prediction.sectionType==="unknown"&&h.children.length===0?o.push(h):h.children.forEach(r))};A(u.boxes,0,null,e);let o=[];r(u.boxes),o.forEach(h=>{F(h,{window:e,target:e.document.body,padding:0,color:h.color,label:h.prediction.sectionType})});let d=u.boxes.children.map(h=>{let y=[p.getXPath(h.div,t)];return y.push(...h.children.map(f=>"- "+p.getXPath(f.div,t))),y.join(`
`)||""}).join(`
`)||"";u.boxes.template={raw:d,hash:E(d)},u.boxes.predictedBoxes=o,console.log("final boxes",u.boxes),u.ui?.toggleOverlays(!0)}return u.ui?.toggleOverlays(!0),u.boxes};window.xp=u;})();
