(()=>{{let i=o=>{typeof o[0]=="string"&&(o[0]=`[detect] ${o[0]}`)},e=console.log;console.log=(...o)=>{i(o),e(...o)},console.debug=(...o)=>{window.DEBUG&&(i(o),e(...o))};let n=console.warn;console.warn=(...o)=>{i(o),n(...o)};let t=console.error;console.error=(...o)=>{i(o),t(...o)}}function C(i){return i.toString(16)}function L(i,e,n,t){return C(i)+C(e)+C(n)+C(t)}var f=class i{constructor({r:e,g:n,b:t,a:o=1,name:s=""}){this.name=s,this.r=e,this.g=n,this.b=t,this.a=o}toHex(){return L(this.r,this.g,this.b,this.a)}static fromRGBA(e){let n=e.replace("rgba(","").replace(")","").split(",").map(t=>parseInt(t.trim()));return new i({r:n[0],g:n[1],b:n[2],a:n[3]})}toRGBA(){return`rgba(${this.r}, ${this.g}, ${this.b}, ${this.a})`}withAlpha(e){return new i({...this,a:e})}static random(e=!1){let n=Math.round(Math.random()*255),t=Math.round(Math.random()*255),o=Math.round(Math.random()*255),s=e?Math.random():1;return new i({name:`rand-${n}-${t}-${o}-${s}`,r:n,g:t,b:o,a:s})}static fromHex(e){let n=parseInt(e.substring(0,2),16),t=parseInt(e.substring(2,4),16),o=parseInt(e.substring(4,6),16),s=parseInt(e.substring(6,8),16);return new i({name:`hex-${n}-${t}-${o}-${s}`,r:n,g:t,b:o,a:s})}};function D(i,e){let n=Math.max(0,Math.min(i.x+i.width,e.x+e.width)-Math.max(i.x,e.x)),t=Math.max(0,Math.min(i.y+i.height,e.y+e.height)-Math.max(i.y,e.y)),o=n*t,s=e.width*e.height;return o/s*100}function q(i,e){let n=i.getBoundingClientRect();return{left:n.left+e.document.scrollingElement.scrollLeft,top:n.top+e.document.scrollingElement.scrollTop}}var y=class i{constructor(e,n,t,o,s){this.id=crypto.randomUUID(),this.x=Math.round(e),this.y=Math.round(n),this.width=Math.round(t),this.height=Math.round(o),this.div=s,this.children=[],this.prediction=null,this.layout=null}static fromDiv(e,n){let t=e.getBoundingClientRect(),o=q(e,n);return new i(o.left,o.top,t.width,t.height,e)}static areBoxesLaidOutAsGrid(e){console.log("areBoxesLaidOutAsGrid");try{if(e.length<2)return!1;let n=e.slice().sort((a,d)=>a.x-d.x||a.y-d.y),t=e.slice().sort((a,d)=>a.y-d.y||a.x-d.x);console.log(n),console.log(t);let o=[];for(let a=1;a<n.length;a++)o.push(n[a].x-n[a-1].x);if([...new Set(o)].length>1)return!1;let r=[];for(let a=1;a<t.length;a++)r.push(t[a].y-t[a-1].y);return!([...new Set(r)].length>1)}finally{return!0}}contains(e,n=!0){return n?e.x-e.width>=this.x-this.width&&e.x+e.width<=this.x+this.width&&e.y-e.height>=this.y-this.height&&e.y+e.height<=this.y+this.height:D(this,e)>75}intersects(e){return!(e.x-e.width>this.x+this.width||e.x+e.width<this.x-this.width||e.y-e.height>this.y+this.height||e.y+e.height<this.y-this.height)}isInside(e){return e.x-e.width<=this.x-this.width&&e.x+e.width>=this.x+this.width&&e.y-e.height<=this.y-this.height&&e.y+e.height>=this.y+this.height}addChild(e){this.children.push(e)}isChild(e){return this.children.some(this.isChild)}determineLayout(){return this.layout={numCols:P(this.children),numRows:$(this.children)},this.layout}};function P(i){if(!i.length)return 0;i.sort((n,t)=>n.x-t.x);let e=[];return i.forEach(n=>{let t=n.x,o=n.x+n.width,s=e[e.length-1];s?t>=s&&e.push(o):e.push(o)}),console.log(e),e.length}function $(i){if(console.log(i),!i.length)return 0;i.sort((n,t)=>n.y-t.y);let e=[];return i.forEach(n=>{let t=n.y,o=n.y+n.height,s=e[e.length-1];s?t>=s-5&&e.push(o):e.push(o)}),console.log(e),e.length}var u=class i{static getXPath(e,n,t=!1){for(var o=n.getElementsByTagName("*"),s=[];e&&e.nodeType==1;e=e.parentNode)if(t)if(e.hasAttribute("id")){for(var r=0,l=0;l<o.length&&(o[l].hasAttribute("id")&&o[l].id==e.id&&r++,!(r>1));l++);if(r==1)return s.unshift('id("'+e.getAttribute("id")+'")'),s.join("/");s.unshift(e.localName.toLowerCase()+'[@id="'+e.getAttribute("id")+'"]')}else e.hasAttribute("class")&&s.unshift(e.localName.toLowerCase()+'[@class="'+[...e.classList].join(" ").trim()+'"]');else{for(var a=1,d=e.previousSibling;d;d=d.previousSibling)d.localName==e.localName&&(a+=1);s.unshift(e.localName.toLowerCase()+"["+a+"]")}return s.length?"/"+s.join("/"):null}static isVisible(e,n){if(!e)return!1;if(e.nodeType===n.Node.DOCUMENT_NODE)return!0;if(e.nodeType===n.Node.ELEMENT_NODE){let t=n.getComputedStyle(e);return t.display.includes("none")||t.visibility.includes("hidden")||t.opacity==="0"?!1:i.isVisible(e.parentNode,n)}}static isUserVisible(e,n){if(!i.isVisible(e,n))return!1;let t=e.getBoundingClientRect(),{width:o,height:s}=i.getPageSize(n.document);return!(t.height===0||t.width===0)}static getNSiblingsDivs(e,n=null){let t=n;isNaN(n)||(t=r=>r===n);let o="",s=[];e.querySelectorAll("div").forEach(r=>{let l=i.getXPath(r,document),a=l.substring(0,l.lastIndexOf("["));s[a]?s[a].push(r):s[a]=[r]});for(let r in s)if(t(s[r].length)){o=r;break}return s[o]||null}static getPageSize(e){var n=e.documentElement,t=e.body,o=Math.max(n.clientWidth,n.scrollWidth,n.offsetWidth,t.scrollWidth,t.offsetWidth),s=Math.max(n.clientHeight,n.scrollHeight,n.offsetHeight,t.scrollHeight,t.offsetHeight);return{width:o,height:s}}static getOffsetRect(e,n){let t=e.getBoundingClientRect(),o=n.document?.scrollingElement?.scrollLeft||0,s=n.document?.scrollingElement?.scrollTop||0;return{x:t.left+o,y:t.top+s,width:t.width,height:t.height}}static checkElStackUpCSSClasses(e,n){let t=e;for(;t;){if(t.classList.contains(n))return!0;t=t.parentElement}return!1}static getAllVisibleElements=(e=document.body,n)=>{let t=[...e.querySelectorAll("*")].filter(r=>!["IFRAME","NOSCRIPT","BR","EM","STRONG","STYLE","SCRIPT"].includes(r.nodeName)).reduce((r,l,a)=>{var d=l.closest("svg");return!(d!==null&&d!==l)&&!r.includes(l.nodeName)&&r.push(l.nodeName),r},[]);console.debug("DOM node types:",t);let s=[...e.querySelectorAll(t.join(","))].filter(r=>i.isUserVisible(r,n));return console.log(`found ${s.length} visible elements in the page.`),s}};var w=class{constructor(...e){e.reduce((n,t,o)=>(n[t]=1<<o,n),this)}},S=class{#e=0;constructor(...e){this.#e=0,this.setFlags(...e)}get flag(){return this.#e}setFlags(...e){this.#e=e.reduce((n,t)=>n|t,0)}setFlag(e){this.#e|=e}unsetFlag(e){this.#e&=~e}isFlagSet(e){return(this.#e&e)!==0}areOnlyFlagsSet(...e){let n=e.reduce((t,o)=>t|o,0);return this.#e===n}getFlags(e){return Object.keys(e).filter(n=>this.isFlagSet(e[n]))}};function b(i){var e=0,n=i.length,t=0;if(n>0)for(;t<n;)e=(e<<5)-e+i.charCodeAt(t++)|0;return e}function A(i){return i?i.replaceAll(`
`," ").replaceAll("	"," ").replaceAll(/\s+/g," ").trim():""}function k(i,...e){return(...n)=>{let t=n[n.length-1]||{},o=[i[0]];return e.forEach((s,r)=>{let l=Number.isInteger(s)?n[s]:t[s];o.push(l,i[r+1])}),o.join("")}}async function z(i){return new Promise(e=>{let n=0,t=500,o=setInterval(()=>{let{scrollHeight:s}=i.document.scrollingElement;n+=t,i.document.scrollingElement.scrollTo({top:n,left:0,behavior:"instant"}),n>=s&&(clearInterval(o),e(!0))},100)})}async function N(i,e={postReset:!0}){try{await z(i),await setTimeout(()=>{},250),e.postReset&&(i.document.scrollingElement.scrollTo({left:0,top:0,behavior:"instant"}),await setTimeout(()=>{},250))}catch(n){throw new Error(`smart scroll failed: ${n}`)}}function H(i,e){let n=null,t=null;return n=[...i.querySelectorAll("*")].some(o=>{let s=e.getComputedStyle(o),r=o.getBoundingClientRect(),l=s.backgroundImage||"none",a="none";if(a&&a.includes("rgba")&&Color.fromRGBA(a).a===0&&(a="none"),l.includes("none")&&a.includes("none"))return!1;if(l||a)return t=o,!0}),n||(n=[...i.querySelectorAll("img")].some(o=>u.isUserVisible(o,e)),n)?t:n}var c=window.xp??{},T=class{constructor({sectionType:e,sectionFeatures:n,template:t,confidence:o}){this.sectionType=e,this.sectionFeatures=n,this.template=t,this.confidence=o}},G=[{name:"header",predictFn:(i,e,n,t)=>!!(t.isFlagSet(h.isFromRootBox)&&e===0)},{name:"footer",predictFn:(i,e,n,t)=>!!(t.isFlagSet(h.isFromRootBox)&&e===n.length-1)},{name:"carousel",predictFn:(i,e,n,t)=>{let o=u.getNSiblingsDivs(i.div,s=>s>=2);if(o){console.log("predict carousel"),console.log(o);let s={};o.forEach(l=>{let a=u.getXPath(l,document),d=[...l.querySelectorAll("div")].map(p=>u.getXPath(p,document).slice(a.length));console.log(d);let g=b(d.join(`
`));console.log(g),s[g]?s[g].push(l):s[g]=[l]});let r=Object.keys(s).filter(l=>s[l].length>1);if(s[r]){let l=!1,a=!1;if(s[r].forEach(d=>{u.isVisible(d,window)?l=!0:a=!0}),l&&a)return!0}return!1}return!1}},{name:"columns",predictFn:(i,e,n,t)=>t.isFlagSet(h.isGridLayout)},{name:"hero",predictFn:(i,e,n,t)=>i.height<=window.innerHeight&&t.isFlagSet(h.hasBackground)&&t.isFlagSet(h.hasHeading)&&t.isFlagSet(h.hasCallToAction)},{name:"heading",predictFn:(i,e,n,t)=>{if(!t.isFlagSet(h.hasHeading))return!1;let o=i.div.cloneNode(!0);o.querySelectorAll("script, style, link, meta, noscript").forEach(l=>l.remove()),console.groupCollapsed("heading");let s=A(o.querySelector("h1, h2, h3, h4, h5, h6")?.textContent),r=A(o.textContent);return console.log(s),console.log(r),console.groupEnd(),t.isFlagSet(h.hasTexts)&&s===r&&t.isFlagSet(h.hasHeading)&&!t.isFlagSet(h.hasImages)&&!t.isFlagSet(h.hasCallToAction)&&!t.isFlagSet(h.hasBackground)}},{name:"text",predictFn:(i,e,n,t)=>t.isFlagSet(h.hasTexts)&&!t.isFlagSet(h.hasImages)&&!t.isFlagSet(h.hasBackground)},{name:"text+icons",predictFn:(i,e,n,t)=>{let o=!0;[...i.div.querySelectorAll("img")].some(l=>{let a=l.getBoundingClientRect();return a.width>50&&a.height>50})&&(o=!1);let r=!i.children.some(l=>(console.log(l.prediction?.sectionType),!["heading","text","text+icons"].includes(l.prediction?.sectionType)));return console.log("childrenOnlyTextLike",r),!t.isFlagSet(h.isGridLayout)&&r&&t.isFlagSet(h.hasTexts)&&o&&!t.isFlagSet(h.hasBackground)}}];c.DOM=u;c.Flags=w;c.FlagSet=S;var V=[new f({name:"violet",r:148,g:0,b:211}),new f({name:"indigo",r:75,g:0,b:130}),new f({name:"blue",r:0,g:0,b:255}),new f({name:"green",r:0,g:255,b:0}),new f({name:"yellow",r:255,g:255,b:0}),new f({name:"orange",r:255,g:127,b:0}),new f({name:"red",r:255,g:0,b:0})];c.filterDivs=i=>{let e=i.filter(t=>{let o=t.getBoundingClientRect(),{width:s,height:r}=u.getPageSize();return!t.classList.contains("xp-ui")&&!t.closest(".xp-ui")&&o.width!==0&&o.height!==0&&o.width*o.height>1e4&&o.width*o.height<.8*s*r&&u.isVisible(t,window)});console.log(e.length),console.log(e.map(t=>t));let n=e.filter(t=>{let o=t.parentElement;for(;o;){let s=t.getBoundingClientRect(),r=o.getBoundingClientRect();if(r.width===0||r.height===0){o=o.parentElement;continue}if(s.width>=.9*r.width&&s.height>=.9*r.height)return!1;o=o.parentElement}return!0});return console.log(n.length),console.log(n.map(t=>t)),n};var U=k`position:absolute;z-index:999999;left:${0}px;top:${1}px;width:${2}px;height:${3}px;border:2px solid ${4};`,O=(i,{target:e=document.body,padding:n=0,color:t=null,label:o=null,domId:s=null,domClasses:r=null})=>{let l=t||"rgba(0, 0, 255, 1)",a=u.getOffsetRect(i.div,window),d=document.createElement("div");if(d.dataset.boxId=i.id,d.dataset.boxXpath=i.xpath,d.dataset.boxDomId=s,d.dataset.boxDomClasses=r,d.dataset.boxData=JSON.stringify((({id:g,x:p,y:x,width:m,height:B,xpath:E,layout:v,domId:R,domClasses:M})=>({id:g,x:p,y:x,width:m,height:B,xpath:E,layout:v,domId:R,domClasses:M}))(i)),d.className="xp-overlay",d.style=U(a.x+n,a.y+n,a.width-n*2-4,a.height-n*2-4,l),o){let g=document.createElement("div");g.className="xp-overlay-label",g.textContent=o,d.appendChild(g);let p;if(s||r){p=document.createElement("div"),p.classList.add("xp-overlay-label","xp-overlay-id");let x="";s&&(x="#"+s),r&&r.length>0&&(x+="."+r),p.innerText=x}d.appendChild(g),p&&d.appendChild(p)}e.appendChild(d)};function F(i,e,n=0,t=V,o=null,s=0){i.children.forEach((r,l)=>{let a=o||t[l%(t.length-1)],d=s===0?1:Math.max(.1,.5-s*.1),g=a.withAlpha(d).toRGBA();r.color=g,O(r,{target:e.document.body,padding:n,color:g,domId:r.domId,domClasses:r.domClasses}),r.children.length>0&&F(r,e,n+2,t,a,s+1)})}var h=new w("isFromRootBox","hasHeader","hasTexts","hasBackground","hasHeading","hasCallToAction","hasImages","hasMultipleColumns","hasMultipleRows","isGridLayout");function I(i,e,n,t=!0){if(i.ignored)return null;let o="unknown",s=new S,r=i.div;t&&s.setFlag(h.isFromRootBox);let l=r.cloneNode(!0);l.querySelectorAll("script, style, link, meta, noscript").forEach(v=>v.remove()),l.textContent.replaceAll(" ","").replaceAll(`
`,"").trim().length>0&&s.setFlag(h.hasTexts),([...r.querySelectorAll("img, picture, svg")].length>0||["IMG","PICTURE","SVG"].includes(r.nodeName))&&s.setFlag(h.hasImages),!!H(i.div,window)&&s.setFlag(h.hasBackground),([...r.querySelectorAll("h1, h2, h3, h4, h5, h6")].length>0||["H1","H2","H3","H4","H5","H6"].includes(r.nodeName))&&s.setFlag(h.hasHeading),[...r.querySelectorAll("a, button")].length>0&&s.setFlag(h.hasCallToAction);let m=i.determineLayout();m.numRows>1&&s.setFlag(h.hasMultipleRows),m.numCols>1&&s.setFlag(h.hasMultipleColumns),m.numCols>1&&y.areBoxesLaidOutAsGrid(i.children)&&s.setFlag(h.isGridLayout),i.children.forEach((...v)=>{I(...v,!1)});let E=G.find(v=>v.predictFn(i,e,n,s));return E?i.prediction=new T({sectionType:E.name,sectionFeatures:s,confidence:-1}):i.prediction=new T({sectionType:"unknown",sectionFeatures:s,confidence:-1}),console.log("prediction"),console.log(s.getFlags(h)),console.log("layout:",m),console.log(r),console.log("section prediction:",i.prediction),o}function j(){let i=[...document.body.querySelectorAll("*")].filter(t=>!["IFRAME","NOSCRIPT","BR","EM","STRONG","STYLE","SCRIPT"].includes(t.nodeName)).reduce((t,o,s)=>{var r=o.closest("svg");return!(r!==null&&r!==o)&&!t.includes(o.nodeName)&&t.push(o.nodeName),t},[]);console.log("DOM node types:",i);let e=[...document.querySelectorAll(i.join(","))],n=c.filterDivs(e);return console.log(`found ${n.length} visible divs to show!`),n}c.getAllVisibleDivs=j;c.buildBoxTree=(i,e)=>{let n=new y(0,0,e.innerWidth,e.document.scrollingElement.scrollHeight),t=i.map(l=>y.fromDiv(l,e));function o(l,a,d){a.forEach((g,p)=>{if(d.has(p))return;if(l.contains(g,!1)){let m=g;l.addChild(m),d.add(p),o(m,a,d)}})}o(n,t,new Set);function s(l){l.determineLayout(),l.children.forEach(s)}s(n);function r(l){if(l.children.length===1&&l.layout.numCols===1){let a=l.children[0];l.children=a.children,r(l)}else l.children.forEach(r)}return r(n),s(n),n};c.getVerticalBoxesFromHierarchy=(i,e=!0)=>{let n={...i};function t(o){let s=o.children;if(s.some(l=>s.some(a=>l!==a&&!l.isInside(a)&&(l.x>=a.x+a.width||l.x+l.width<=a.x)))){o.setChildren([]);return}else for(let l=0;l<s.length;l++)t(s[l])}return t(n),n.children};c.boxes=null;c.highlightVerticalBoxes=()=>{let i=c.getAllVisibleDivs(),e=c.buildBoxTree(i),n=c.getVerticalBoxesFromHierarchy(e,!1),t=new y(0,0,window.innerWidth,window.document.scrollingElement.scrollHeight);t.setChildren(n),F(t)};c.analysePage=async()=>{c.ui?.resetOverlays();let i=u.getAllVisibleElements();c.boxes=c.buildBoxTree(i),F(c.boxes),console.log(c.boxes),c.ui?.toggleOverlays(!0);let e=c.boxes.children.map(n=>u.getXPath(n.div,document)).join(`
`)||"";return c.boxes.template={raw:e,hash:b(e)},c.boxes.children.forEach((n,t,o)=>{I(n,t,o)}),c.boxes};c.predictPage=()=>{if(c.boxes?.children?.length>0){let e=function(t){t.ignored||(t.prediction&&t.prediction.sectionType!=="unknown"||t.prediction&&t.prediction.sectionType==="unknown"&&t.children.length===0?(i.push(t),console.warn(t.div,t.prediction),c.ui&&O(t,{padding:0,color:"rgba(0, 255, 0, 1)",label:t.prediction.sectionType,domId:t.domId,domClasses:t.domClasses})):t.children.forEach(e))};c.ui?.resetOverlays(),c.boxes.children.forEach((t,o,s)=>{I(t,o,s)});let i=[];e(c.boxes);let n=c.boxes.children.map(t=>{let o=[u.getXPath(t.div,document)];return o.push(...t.children.map(s=>"- "+u.getXPath(s.div,document))),o.join(`
`)||""}).join(`
`)||"";return console.log(c.boxes),c.boxes.template={raw:n,hash:b(n)},c.ui?.toggleOverlays(!0),c.boxes}};c.selectElementToIgnore=()=>{document.body.style.cursor="crosshair",c.ui.overlaysDiv().addEventListener("click",e=>{let n=e.target;n.classList.contains("xp-overlay")&&n.remove(),c.ignoreElementForDection(n.dataset.boxId),document.body.style.removeProperty("cursor")},{once:!0})};c.ignoreElementForDection=i=>{function e(n){if(n.id===i){let t=function(o){[...c.ui.overlaysDiv().querySelectorAll(".xp-overlay")].forEach(r=>{r.dataset.boxId===o.id&&r.remove()}),o.children.forEach(t)};return n.ignored=!0,t(n),!0}else return n.children.some(e)}e(c.boxes)};c.detectSections=async(i,e)=>{c.ui?.resetOverlays(),await N(e);let{document:n}=e,t=u.getAllVisibleElements(i,e);console.log("visible divs",t),t=t.filter(l=>{let a=l.getBoundingClientRect();return a.width*a.height>3e4}),console.log("filtered divs",t);let o=c.buildBoxTree(t,e);console.log("boxes hierarchy",o);function s(l,a){l.div&&(l.xpath=u.getXPath(l.div,a),l.id=`box-id-${b(l.xpath)}`,l.domId=l.div.id.length>0?l.div.id:void 0,l.div.classList&&l.div.classList.length>0&&(l.domClasses=[...l.div.classList].join("."))),l.children&&l.children.length>0&&l.children.forEach(d=>s(d,a))}s(o,n),F(o,e);let r=o.children.map(l=>{let a=[l.xpath];return a.push(...l.children.map(d=>"- "+d.xpath)),a.join(`
`)||""}).join(`
`)||"";return console.log("template",r),c.boxes=o,c.template={raw:r,hash:b(r)},c.ui?.toggleOverlays(!0),o};window.xp=c;})();
